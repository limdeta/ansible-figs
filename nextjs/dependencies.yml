---
- name: Install nginx and npm
  hosts: all
  vars_files: 
    - common_vars.yml

  roles:
    - name: Ensure NGINX is installed
      apt:
        name: nginx
        state: present
        update_cache: yes

    - name: Ensure custom NGINX configuration file exists
      copy:
        dest: "{{ nginx_config }}"
        content: |
          server {
            listen 80;
            server_name your_domain_or_ip;

            root {{ current_link }};
            index index.html;

            location / {
              try_files $uri $uri/ =404;
            }
          }
        owner: root
        group: root
        mode: '0644'

    - name: Enable custom NGINX configuration
      file:
        src: "{{ nginx_config }}"
        dest: "/etc/nginx/sites-enabled/nginx-test"
        state: link
      notify: Restart NGINX

    - name: Ensure the backup directory exists
      file:
        path: "{{ backup_dir }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - role: ansible-role-nvm
      nodejs_version: "{{ node_version }}"
      nvm_commands:
       - "nvm exec default npm install"

  handlers:
    - name: Restart NGINX
      service:
        name: nginx
        state: restarted

# ansible-playbook -i inventory.ini dependencies.yml --ask-password